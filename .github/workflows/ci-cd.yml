deploy-to-kind:
  needs: build-and-push
  if: github.event_name == 'push' && github.ref == 'refs/heads/main'
  runs-on: ubuntu-latest
  
  steps:
  - name: Checkout code
    uses: actions/checkout@v3
    
  - name: Set lowercase repository name
    run: |
      echo "LOWERCASE_REPO=${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV
    
  - name: Create Kind Kubernetes Cluster
    uses: helm/kind-action@v1.5.0
    with:
      cluster_name: kind
      wait: 120s
      version: v0.20.0
    
  - name: Pull Docker image from GHCR
    run: |
      docker pull ghcr.io/${{ env.LOWERCASE_REPO }}:latest
    
  - name: Load Docker image into Kind
    run: |
      kind load docker-image ghcr.io/${{ env.LOWERCASE_REPO }}:latest --name kind
    
  - name: Verify image is loaded
    run: |
      docker exec kind-control-plane crictl images | grep ai-devops
    
  - name: Deploy to Kind Cluster
    run: |
      # Ensure imagePullPolicy is set to IfNotPresent
      sed -i 's/imagePullPolicy:.*/imagePullPolicy: IfNotPresent/' k8s/deployment.yaml
      
      kubectl apply -f k8s/
      kubectl rollout status deployment/sfe-devops-app --timeout=120s
      kubectl get pods
      kubectl get services
    
  - name: Debug if failed
    if: failure()
    run: |
      kubectl describe pods
      kubectl logs -l app=sfe-devops-app --tail=50
    
  - name: Test Application
    run: |
      # Wait for pods to be ready
      kubectl wait --for=condition=ready pod -l app=sfe-devops-app --timeout=60s
      
      # Port-forward to access the service
      kubectl port-forward service/sfe-devops-app-service 8080:80 &
      sleep 5
      
      # Test endpoints
      echo "Testing /health endpoint..."
      curl http://localhost:8080/health
      
      echo -e "\n\nTesting / endpoint..."
      curl http://localhost:8080/
      
      echo -e "\n\nâœ… Deployment successful!"